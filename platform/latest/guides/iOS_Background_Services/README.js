Ext.data.JsonP['iOS_Background_Services']({"guide":" <!doctype html> <html> <head> <title>iOS Background Services</title> <meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\"> </meta></head> <body> <div class=\"container\"> <div class=\"header\"/> <div id=\"src-37539664\" class=\"content\"> <h1>iOS Background Services</h1> <p> </p> <ul class=\"toc-indentation\"><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Introduction\">Introduction</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-URLsessionmodule\">URL session module</a> </p> <ul class=\"toc-indentation\"><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-CreatingaURLsessionandbackgrounddownloadtask\">Creating a URL session and background download task</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-MonitoringthedownloadtaskandURLsession\">Monitoring the download task and URL session</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-InvalidatingtheURLsession\">Invalidating the URL session</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Example\">Example</a> </p> </li></ul></li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Backgroundfetch\">Background fetch</a> </p> <ul class=\"toc-indentation\"><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Settingapplicationpermissions\">Setting application permissions</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Monitoringthebackgroundfetchnotification\">Monitoring the background fetch notification</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Example.1\">Example</a> </p> </li></ul></li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Silentpush\">Silent push</a> </p> <ul class=\"toc-indentation\"><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Settingapplicationpermissions.1\">Setting application permissions</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Monitoringsilentpushnotifications\">Monitoring silent push notifications</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Subscribingtopushnotifications\">Subscribing to push notifications</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Sendingasilentpushnotification\">Sending a silent push notification</a> </p> </li><li class=\"\"> <p><a class=\"document-link\" href=\"#!/guide/iOS_Background_Services-section-src-37539664_iOSBackgroundServices-Example.2\">Example</a> </p> </li></ul></li></ul> <div class=\"section section-2\" id=\"src-37539664_iOSBackgroundServices-Introduction\"> <h2 class=\"heading\"><span>Introduction</span></h2> <p>In iOS 7, Apple introduced new background execution modes which allow the application to download content in the background. These background modes are supported in Titanium SDK 3.2.0 and later, which are exposed as the following APIs: </p> <ul class=\"\"><li class=\"\"> <p><strong>URL session module</strong>: a wrapper for the NSURLSession class that allows the application to download large content in the background. This module provides the main functionality for the background execution modes, such as creating the background download task and monitoring the download once it starts. </p> </li><li class=\"\"> <p><strong>Background fetch event</strong>: use to monitor signals from iOS to update the application while in the background. </p> </li><li class=\"\"> <p><strong>Silent push event</strong>: use to monitor a push notification to tell the application there is content to download. </p> </li></ul> <p>With the Titanium platform, the background fetch and silent push events <strong>cannot</strong> be tested on the iOS simulator. These events can only be triggered on device. </p> </div> <div class=\"section section-2\" id=\"src-37539664_iOSBackgroundServices-URLsessionmodule\"> <h2 class=\"heading\"><span>URL session module</span></h2> <p>The <a class=\"external-link external-link\" href=\"#!/api/Modules.URLSession\">URL session module (<tt>com.appcelerator.urlSession</tt>)</a> provides a significant portion of the functionality to support background download tasks. It allows applications to download content via HTTP. With this module, you can </p> <ol class=\"\"><li> <p>Create a URL session and a background download task. </p> </li><li> <p>Monitor events to check the progress of the download and session. </p> </li><li> <p>Cancel downloads and invalidate sessions. </p> </li></ol> <p>Before using this module, you need to add it to your project. This module is part of the Titanium SDK since Release 3.2.0 and does not need to be downloaded to obtain it. To add this module to your project: </p> <p><strong>Using Studio</strong> </p> <ol class=\"\"><li class=\"\"> <p>Double-click the <tt class=\"\">tiapp.xml</tt> file to open it in the <strong>Overview</strong> tab. </p> </li><li class=\"\"> <p>In the <strong class=\"\">Modules</strong> section, click the <strong class=\"\">Add</strong> button (green plus sign) to open the <strong>Mobile Modules</strong> dialog. </p> </li><li class=\"\"> <p>Locate and select <strong>com.appcelerator.urlSession</strong>. </p> </li><li class=\"\"> <p>Click <strong>OK</strong>. </p> </li></ol> <p><strong>Using a text editor</strong> </p> <p>Open the <tt class=\"\">tiapp.xml</tt> file and add the following under the <tt>modules</tt> element: </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"title\">tiapp.xml</div> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\" data-title=\"tiapp.xml\"> <div class=\"line\"><code class=\"plain\">...</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">modules</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">module</code><code class=\"plain\"> </code><code class=\"color1\">platform</code><code class=\"plain\">=</code><code class=\"string\">&quot;iphone&quot;</code><code class=\"plain\">&gt;com.appcelerator.urlSession&lt;/</code><code class=\"keyword\">module</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">modules</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\">...</code></div> </div> </div> <p>Initiate the module with the <tt>require(&apos;com.appcelerator.urlSession&apos;)</tt> method and make subsequent API calls with the new object: </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Require in the module</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> urlSession = require(</code><code class=\"string\">&apos;com.appcelerator.urlSession&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> sessionConfig = urlSession.createSessionConfiguration({</code></div> <div class=\"line\"><code class=\"plain\"> identifier: </code><code class=\"string\">&apos;com.appcelerator.sessionx&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-CreatingaURLsessionandbackgrounddownloadtask\"> <h3 class=\"heading\"><span>Creating a URL session and background download task</span></h3> <p>A URL session object is used to manage your download tasks. </p> <p>Before creating a URL session object, you need to create a session configuration using the <tt>createURLSessionBackgroundConfiguration</tt> method. Pass this method an arbitrary string, which is used to identify the session when monitoring events. </p> <p>To create a URL session object, pass the session configuration object to the <tt>createURLSession</tt> method. </p> <p>To create a background download task, pass the session object and the URL to download the asset to the <tt>backgroundDownloadTaskWithURL</tt> method. Once you have created the task, the download starts. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Require in the module</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> urlSession = require(</code><code class=\"string\">&apos;com.appcelerator.urlSession&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// Create a session configuration</code></div> <div class=\"line\"><code class=\"comments\">// The string parameter is an arbitrary string used to identify the session in events</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> sessionConfig = urlSession.createSessionConfiguration({</code></div> <div class=\"line\"><code class=\"plain\"> identifier: </code><code class=\"string\">&apos;com.appcelerator.sessionx&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// Create a URL session object based on the </code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> session = urlSession.createSession({</code></div> <div class=\"line\"><code class=\"plain\"> configuration: sessionConfig</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> task = session.downloadTask({</code></div> <div class=\"line\"><code class=\"plain\"> url: </code><code class=\"string\">&apos;http://download.foo.com/myimage.png&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-MonitoringthedownloadtaskandURLsession\"> <h3 class=\"heading\"><span>Monitoring the download task and URL session</span></h3> <p>Once your download starts, you can monitor its progress with the following events: </p> <ul class=\"\"><li class=\"\"> <p class=\"diff-line-pre\"><tt class=\"\">backgroundtransfer</tt>: fired when URL session events are waiting to be processed. Use the <tt class=\"\">handlerId</tt> and <tt>sessionId</tt> properties to track the task and session that needs to be managed. </p> </li><li class=\"\"> <p class=\"diff-line-pre\"><tt class=\"\">downloadprogress</tt>: fired periodically to show the progress of the download. Use the <tt class=\"\">totalBytesWritten</tt> and <tt>totalBytesExpectedToWrite</tt> properties to track its progress. </p> </li><li class=\"\"> <p class=\"diff-line-pre\"><tt class=\"\">downloadcompleted</tt>: fired when the download completes. The save data is stored in the <tt>data</tt> property. </p> </li><li class=\"\"> <p class=\"diff-line-pre\"><tt>sessioncompleted</tt>: fired when the all session tasks complete. </p> </li><li class=\"\"> <p class=\"diff-line-pre\"><tt>sessioneventscompleted</tt>: fired when all session messages are delivered. </p> </li></ul> <p>These events are monitored as application-level events by using the <tt class=\"\">addEventListener</tt> method with the <tt>Ti.App.iOS</tt> namespace. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Monitor this event to receive updates on the progress of the download</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadprogress&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the progress indicator</code></div> <div class=\"line\"><code class=\"plain\"> progress.value = (e.totalBytesWritten / e.totalBytesExpectedToWrite);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when the download completes</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadcompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Save downloaded asset</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">var</code><code class=\"plain\"> file = Ti.Filesystem.getFile(</code><code class=\"string\">&apos;/default.png&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> file.write(e.data);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when all session tasks have completed</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;sessioncompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\"> (e.success) {</code></div> <div class=\"line\"><code class=\"plain\"> alert(</code><code class=\"string\">&apos;Downloads completed successfully.&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> }</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-InvalidatingtheURLsession\"> <h3 class=\"heading\"><span>Invalidating the URL session</span></h3> <p>Once you are done with the URL session or want to abort it, invalidate the session by passing the URL session object to either of the following methods: </p> <ul class=\"\"><li class=\"\"> <p><tt>finishTasksAndInvalidate</tt>: invalidates the session but allows the tasks to finish. </p> </li><li class=\"\"> <p><tt>invalidateAndCancel</tt>: invalidates the session but cancels any running tasks. </p> </li></ul> <p>If you do not invalidate your URL session after it has completed, your application may leak memory. </p> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Example\"> <h3 class=\"heading\"><span>Example</span></h3> <p>In the following example, the user initiates a download by pressing a button. The user can either wait for the download to finish in the foreground or send the application to the background. A banner message will alert the user that the download has finished if the application is in the background. After the download is done, the application displays the downloaded image. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Require in the urlSession module</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> urlSession = require(</code><code class=\"string\">&apos;com.appcelerator.urlSession&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Create a session configuration</code></div> <div class=\"line\"><code class=\"comments\">// The string parameter is an arbitrary string used to identify the session in events</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> sessionConfig = urlSession.createSessionConfiguration({</code></div> <div class=\"line\"><code class=\"plain\"> identifier: </code><code class=\"string\">&apos;com.appcelerator.test&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"comments\">// Create a session</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> session = urlSession.createSession({</code></div> <div class=\"line\"><code class=\"plain\"> configuration: sessionConfig</code></div> <div class=\"line\"><code class=\"plain\">}); </code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// App UI</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> win = Ti.UI.createWindow({</code></div> <div class=\"line\"><code class=\"plain\"> backgroundColor: </code><code class=\"string\">&apos;white&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> progress = Ti.UI.createProgressBar({</code></div> <div class=\"line\"><code class=\"plain\"> width: 200,</code></div> <div class=\"line\"><code class=\"plain\"> height: 50,</code></div> <div class=\"line\"><code class=\"plain\"> min: 0,</code></div> <div class=\"line\"><code class=\"plain\"> max: 1,</code></div> <div class=\"line\"><code class=\"plain\"> value: 0,</code></div> <div class=\"line\"><code class=\"plain\"> style: Ti.UI.iOS.ProgressBarStyle.PLAIN,</code></div> <div class=\"line\"><code class=\"plain\"> top: 10,</code></div> <div class=\"line\"><code class=\"plain\"> message: </code><code class=\"string\">&apos;Downloading Image&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> font: { fontSize: 12, fontWeight: </code><code class=\"string\">&apos;bold&apos;</code><code class=\"plain\">},</code></div> <div class=\"line\"><code class=\"plain\"> color: </code><code class=\"string\">&apos;#888&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">win.add(progress);</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> imageView = Ti.UI.createImageView({</code></div> <div class=\"line\"><code class=\"plain\"> top: 150,</code></div> <div class=\"line\"><code class=\"plain\"> height: 300,</code></div> <div class=\"line\"><code class=\"plain\"> width: 200</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">win.add(imageView);</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> button = Ti.UI.createButton({</code></div> <div class=\"line\"><code class=\"plain\"> title: </code><code class=\"string\">&apos;Download Image (url)&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> height: 40,</code></div> <div class=\"line\"><code class=\"plain\"> width: 200,</code></div> <div class=\"line\"><code class=\"plain\"> top: 70</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\">button.addEventListener(</code><code class=\"string\">&apos;click&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">() {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Create a background download task to get the asset with the URL</code></div> <div class=\"line\"><code class=\"plain\"> session.downloadTask({</code></div> <div class=\"line\"><code class=\"plain\"> url: </code><code class=\"string\">&apos;https://raw.github.com/appcelerator-developer-relations/KitchenSink/master/Resources/images/dog@2x~iphone.jpg&apos;</code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> progress.show();</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\">win.add(button);</code></div> <div class=\"line\"><code class=\"plain\">win.open();</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// Monitor this event to receive updates on the progress of the download</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadprogress&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the progress indicator</code></div> <div class=\"line\"><code class=\"plain\"> progress.value = (e.totalBytesWritten / e.totalBytesExpectedToWrite);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when the download completes</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadcompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Download completed: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the image</code></div> <div class=\"line\"><code class=\"plain\"> imageView.image = e.data;</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Invalidate the session and cancel current session tasks</code></div> <div class=\"line\"><code class=\"plain\"> session.invalidateAndCancel();</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Notify the user the download is complete if the application is in the background</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.scheduleLocalNotification({</code></div> <div class=\"line\"><code class=\"plain\"> alertBody: </code><code class=\"string\">&apos;Download completed!&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> date: </code><code class=\"keyword\">new</code><code class=\"plain\"> Date().getTime() </code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\"> progress.hide();</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when all session tasks have completed</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;sessioncompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;sessioncompleted: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\"> (e.success) {</code></div> <div class=\"line\"><code class=\"plain\"> alert(</code><code class=\"string\">&apos;Downloads completed successfully.&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> }</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> </div> </div> </div> </div> <div class=\"section section-2\" id=\"src-37539664_iOSBackgroundServices-Backgroundfetch\"> <h2 class=\"heading\"><span>Background fetch</span></h2> <p>If the application is in the background and the background fetch permission is enabled, iOS will periodically signal the application when it can download data in the background. Note that these notifications are at the discretion of iOS. iOS studies how the user interacts with your application and considers the current state of the device, such as the battery charage, to determine the best time to trigger background updates. </p> <p>You need to modify your application to: </p> <ol class=\"\"><li> <p>Have permission to listen for fetch notification in the background </p> </li><li class=\"\"> <p>Set the fetch interval and monitor the <tt>backgroundfetch</tt> event to initiate the download </p> </li></ol> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Settingapplicationpermissions\"> <h3 class=\"heading\"><span>Setting application permissions</span></h3> <p>To use the background fetch functionality, modify your <tt class=\"\">tiapp.xml</tt> file to add the <tt class=\"\">UIBackgroundMode</tt> <tt class=\"\">s</tt> <tt>fetch</tt> key in the plist section: </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"title\">tiapp.xml</div> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\" data-title=\"tiapp.xml\"> <div class=\"line\"><code class=\"plain\">...</code></div> <div class=\"line\"><code class=\"plain\">&lt;</code><code class=\"keyword\">ios</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">plist</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">dict</code><code class=\"plain\">&gt; </code></div> <div class=\"line\"><code class=\"plain\"> ...</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">key</code><code class=\"plain\">&gt;UIBackgroundModes&lt;/</code><code class=\"keyword\">key</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">array</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">string</code><code class=\"plain\">&gt;fetch&lt;/</code><code class=\"keyword\">string</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">array</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">dict</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">plist</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\">&lt;/</code><code class=\"keyword\">ios</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\">...</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Monitoringthebackgroundfetchnotification\"> <h3 class=\"heading\"><span>Monitoring the background fetch notification</span></h3> <p>Use the <a class=\"external-link external-link\" href=\"#!/api/Titanium.App.iOS-method-setMinimumBackgroundFetchInterval\">Ti.App.iOS.setMinimumBackgroundFetchInterval</a> method when the application first starts to set the minimum interval between fetch operations. This value does not indicate the exact amount of time expected between fetch operations. iOS determines, based on device&apos;s status and how the user interacts with your application, when an appropriate time is to initiate the download. You can set the value to either: </p> <ul class=\"\"><li class=\"\"> <p><tt>Ti.App.iOS.BACKGROUNDFETCHINTERVAL_MIN</tt>: smallest interval supported by the system. </p> </li><li class=\"\"> <p><tt>Ti.App.iOS.BACKGROUNDFETCHINTERVAL_NEVER</tt>: largest interval to prevent fetch operations. </p> </li></ul> <p>Use the iOS application-level <tt class=\"\">backgroundfetch</tt> event to monitor when the application receives a notification from iOS that it can initiate a background download. This notification can be received while the application is in the background. Once this event is triggered, you can initiate a download, then call the <tt class=\"\">Ti.App.iOS.endBackgroundHandler</tt> method to put the application back to sleep. Pass the backgroundfetch event&apos;s <tt class=\"\">handlerId</tt> property to the <tt>endBackgroundHandler</tt> method. </p> <p>If your application is awake for more than 30 seconds, iOS suspends your application. If your application breaks this condition often, iOS may mark your application as resource intensive and be given fewer opportunities to download data in the background. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Monitor this event for a signal from iOS to fetch data</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;backgroundfetch&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) { </code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Initiate a download operation</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Put the application back to sleep</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.endBackgroundHandler(e.handlerId);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Example.1\"> <h3 class=\"heading\"><span>Example</span></h3> <p>In the following example, when the application enters the background and the device is left alone, iOS will eventually signal the application that it is OK to perform a background fetch. This signal is not reliably reproducible and occurs randomly at the discretion of iOS. Banner messages will be displayed when the download starts and finishes. When the application is back in the foreground and the download is complete, the image will be replaced with the downloaded image. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Require in the urlSession module</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> urlSession = require(</code><code class=\"string\">&apos;com.appcelerator.urlSession&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Initiate the download</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> sessionConfig = urlSession.createSessionConfiguration({</code></div> <div class=\"line\"><code class=\"plain\"> identifier: </code><code class=\"string\">&apos;com.appcelerator.backgroundfetch&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> session = urlSession.createSession({</code></div> <div class=\"line\"><code class=\"plain\"> configuration: sessionConfig</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Set the fetch interval level</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.setMinimumBackgroundFetchInterval(Ti.App.iOS.BACKGROUNDFETCHINTERVAL_MIN);</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// App UI</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> win = Ti.UI.createWindow({</code></div> <div class=\"line\"><code class=\"plain\"> backgroundColor: </code><code class=\"string\">&apos;white&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> progress = Ti.UI.createProgressBar({</code></div> <div class=\"line\"><code class=\"plain\"> width: 200,</code></div> <div class=\"line\"><code class=\"plain\"> height: 50,</code></div> <div class=\"line\"><code class=\"plain\"> min: 0,</code></div> <div class=\"line\"><code class=\"plain\"> max: 1,</code></div> <div class=\"line\"><code class=\"plain\"> value: 0,</code></div> <div class=\"line\"><code class=\"plain\"> style: Ti.UI.iOS.ProgressBarStyle.PLAIN,</code></div> <div class=\"line\"><code class=\"plain\"> top: 10,</code></div> <div class=\"line\"><code class=\"plain\"> message: </code><code class=\"string\">&apos;Downloading image&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> font: { fontSize: 12, fontWeight: </code><code class=\"string\">&apos;bold&apos;</code><code class=\"plain\">},</code></div> <div class=\"line\"><code class=\"plain\"> color: </code><code class=\"string\">&apos;#888&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">win.add(progress);</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> imageView = Ti.UI.createImageView({</code></div> <div class=\"line\"><code class=\"plain\"> top: 100,</code></div> <div class=\"line\"><code class=\"plain\"> height: 350,</code></div> <div class=\"line\"><code class=\"plain\"> width: 250,</code></div> <div class=\"line\"><code class=\"plain\"> image: </code><code class=\"string\">&apos;https://raw.github.com/appcelerator-developer-relations/KitchenSink/master/Resources/images/fence@2x.jpg&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">win.add(imageView);</code></div> <div class=\"line\"><code class=\"comments\">// Monitor this event for a signal from iOS to fetch data</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;backgroundfetch&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) { </code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;backgroundfetch: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"plain\"> session.downloadTask({</code></div> <div class=\"line\"><code class=\"plain\"> url: </code><code class=\"string\">&apos;https://raw.github.com/appcelerator-developer-relations/KitchenSink/master/Resources/images/dog@2x~iphone.jpg&apos;</code></div> <div class=\"line\"><code class=\"plain\"> }); </code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Display a banner message when the download starts</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.scheduleLocalNotification({</code></div> <div class=\"line\"><code class=\"plain\"> alertBody: </code><code class=\"string\">&apos;Background download initiated ...&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> date: </code><code class=\"keyword\">new</code><code class=\"plain\"> Date().getTime() </code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\"> progress.show(); </code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Put the application back to sleep</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.endBackgroundHandler(e.handlerId);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to receive updates on the progress of the download</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadprogress&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the progress indicator</code></div> <div class=\"line\"><code class=\"plain\"> progress.value = (e.totalBytesWritten / e.totalBytesExpectedToWrite);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when the download completes</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadcompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Download completed: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the image</code></div> <div class=\"line\"><code class=\"plain\"> imageView.image = e.data;</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Invalidates the session and cancel any current session tasks</code></div> <div class=\"line\"><code class=\"plain\"> session.invalidateAndCancel();</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Display a banner message when the download finishes</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.scheduleLocalNotification({</code></div> <div class=\"line\"><code class=\"plain\"> alertBody: </code><code class=\"string\">&apos;Download completed!&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> date: </code><code class=\"keyword\">new</code><code class=\"plain\"> Date().getTime() </code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\"> progress.hide();</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when all session tasks have completed</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;sessioncompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;sessioncompleted: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\"> (e.success) {</code></div> <div class=\"line\"><code class=\"plain\"> alert(</code><code class=\"string\">&apos;Downloads completed successfully.&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> }</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"plain\">win.open();</code></div> </div> </div> </div> </div> <div class=\"section section-2\" id=\"src-37539664_iOSBackgroundServices-Silentpush\"> <h2 class=\"heading\"><span>Silent push</span></h2> <p>In order to use the <tt class=\"\">silentpush</tt> event to monitor silent remote push notifications, you need to setup your project to use push notifications as described in the <a class=\"document-link\" href=\"#!/guide/Push_Notifications\">Push Notifications</a> guide. </p> <p>After you have push notifications setup, you need to modify your application to: </p> <ol class=\"\"><li> <p>Have permission to listen for remote notifications in the background </p> </li><li class=\"\"> <p>Monitor the <tt>silentpush</tt> event to initiate the download </p> </li><li> <p>Subscribe the device to push notifications </p> </li></ol> <p>Once your application is prepared, you can test it by sending a push notification to it. </p> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Settingapplicationpermissions.1\"> <h3 class=\"heading\"><span>Setting application permissions</span></h3> <p>To use the silent push functionality, modify your <tt class=\"\">tiapp.xml</tt> file to add the <tt class=\"\">UIBackgroundMode</tt> <tt class=\"\">s</tt> <tt>remote-notification</tt> key in plist section: </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"title\">tiapp.xml</div> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\" data-title=\"tiapp.xml\"> <div class=\"line\"><code class=\"plain\">...</code></div> <div class=\"line\"><code class=\"plain\">&lt;</code><code class=\"keyword\">ios</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">plist</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">dict</code><code class=\"plain\">&gt; </code></div> <div class=\"line\"><code class=\"plain\"> ...</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">key</code><code class=\"plain\">&gt;UIBackgroundModes&lt;/</code><code class=\"keyword\">key</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">array</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;</code><code class=\"keyword\">string</code><code class=\"plain\">&gt;remote-notification&lt;/</code><code class=\"keyword\">string</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">array</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">dict</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\"> &lt;/</code><code class=\"keyword\">plist</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\">&lt;/</code><code class=\"keyword\">ios</code><code class=\"plain\">&gt;</code></div> <div class=\"line\"><code class=\"plain\">...</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Monitoringsilentpushnotifications\"> <h3 class=\"heading\"><span>Monitoring silent push notifications</span></h3> <p>Use the iOS application-level <tt class=\"\">silentpush</tt> event to monitor when the application receives a silent push notification. This notification can be received while the application is in the background. Once this event is triggered, you can initiate a download, then call the <tt class=\"\">Ti.App.iOS.endBackgroundHandler</tt> method to put the application back to sleep. Pass the <tt class=\"\">silentpush</tt> event&apos;s <tt class=\"\">handlerId</tt> property to the <tt>endBackgroundHandler</tt> method. </p> <p>If custom fields were sent in the push notification, these fields are available as properties of object passed to the event callback. </p> <p>If your application is awake for more than 30 seconds, iOS suspends your application. If your application breaks this condition often, iOS may mark your application as resource intensive and be given fewer opportunities to download data in the background. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Monitor silent push notifications</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;silentpush&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Initiate a download operation</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Put the application back to sleep</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.endBackgroundHandler(e.handlerId);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Subscribingtopushnotifications\"> <h3 class=\"heading\"><span>Subscribing to push notifications</span></h3> <p>In order to receive the silent remote notification, the device needs to be subscribed to push notifications. Use the <a class=\"external-link external-link\" href=\"#!/api/Titanium.Network-method-registerForPushNotifications\">Ti.Network.registerForPushNotifications method</a> to register for push notifications and setup callbacks when the application first starts, then use either the Cloud module&apos;s <tt class=\"\">PushNotifications.subscribeToken</tt> or <tt>PushNotifications.subscribe</tt> method to subscribe to a push channel. </p> <p>The <tt class=\"\">subscribe</tt> method requires the user to be logged in to Arrow to subscribe and receive push notifications, while <tt>subscribeToken</tt> only relies on the device token. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"comments\">// Require in the Cloud module</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> Cloud = require(</code><code class=\"string\">&apos;ti.cloud&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// Register for push notification</code></div> <div class=\"line\"><code class=\"plain\">Ti.Network.registerForPushNotifications({</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Only need to listen to alerts</code></div> <div class=\"line\"><code class=\"plain\"> types: [Ti.Network.NOTIFICATION_TYPE_ALERT],</code></div> <div class=\"line\"><code class=\"plain\"> success: deviceTokenSuccess,</code></div> <div class=\"line\"><code class=\"plain\"> error: deviceTokenError</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">function</code><code class=\"plain\"> deviceTokenSuccess(e) {</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Subscribes the device to the &apos;silent_push&apos; channel to listen for silent push alerts</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// The channel name is arbitrary and can be anything you wish</code></div> <div class=\"line\"><code class=\"plain\"> Cloud.PushNotifications.subscribeToken({</code></div> <div class=\"line\"><code class=\"plain\"> device_token: e.deviceToken,</code></div> <div class=\"line\"><code class=\"plain\"> channel: </code><code class=\"string\">&apos;silent_push&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> type: </code><code class=\"string\">&apos;ios&apos;</code></div> <div class=\"line\"><code class=\"plain\"> }, </code><code class=\"keyword\">function</code><code class=\"plain\"> (e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\"> (e.success) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Subscribed&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> } </code><code class=\"keyword\">else</code><code class=\"plain\"> {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Error:\\n&apos;</code><code class=\"plain\"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div> <div class=\"line\"><code class=\"plain\"> }</code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\">}</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">function</code><code class=\"plain\"> deviceTokenError(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Failed to register for push notifications: &apos;</code><code class=\"plain\"> + e.error);</code></div> <div class=\"line\"><code class=\"plain\">}</code></div> </div> </div> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Sendingasilentpushnotification\"> <h3 class=\"heading\"><span>Sending a silent push notification</span></h3> <p>To send a silent push notification to the application to trigger the download, use the Appcelerator Dashboard to send the following payload to the push channel and subscribed devices: </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"line\"><code class=\"plain\">{</code><code class=\"string\">&quot;alert&quot;</code><code class=\"plain\">: </code><code class=\"string\">&quot;&quot;</code><code class=\"plain\">, </code><code class=\"string\">&quot;content-available&quot;</code><code class=\"plain\">: 1}</code></div> </div> </div> <p>The payload only requires the following two field but you may use others: </p> <ul class=\"\"><li class=\"\"> <p>The <tt>content-available</tt> field indicates that there is new content to download. </p> </li><li class=\"\"> <p>The <tt>alert</tt> field still needs to be included but does not require a value. If this field is left blank as shown, a banner message is not displayed to the user. </p> </li></ul> <p>If the push notification contains custom fields, these are stored as properties to the object passed to the <tt>silentpush</tt> callback. </p> </div> <div class=\"section section-3\" id=\"src-37539664_iOSBackgroundServices-Example.2\"> <h3 class=\"heading\"><span>Example</span></h3> <p>In the following example, the user needs to launch the application at least once, so the application can register for push notifications. When the application enters the background, you can send a silent push notification to initiate a download, with the content URL as the <tt>download_url</tt> field in the push payload. Banner messages will be displayed when the download starts and finishes. When the application is back in the foreground and the download is complete, the image will be replaced with the downloaded image. </p> <p>This example requires that push notifications are setup for the project. For directions, see <a class=\"document-link\" href=\"#!/guide/Push_Notifications\">Push Notifications</a>. </p> <div class=\"confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code\"> <div class=\"title\">app.js</div> <div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"defaultnew syntaxhighlighter scroll-html-formatted-code\" data-title=\"app.js\"> <div class=\"line\"><code class=\"comments\">// Send the following push notification to this example:</code></div> <div class=\"line\"><code class=\"comments\">// {&quot;alert&quot;:&quot;&quot;,&quot;content-available&quot;:1,&quot;download_url&quot;:&quot;https://raw.github.com/appcelerator-developer-relations/KitchenSink/master/Resources/images/dog@2x~iphone.jpg&quot;}</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// Require in the urlSession and Cloud modules</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> urlSession = require(</code><code class=\"string\">&apos;com.appcelerator.urlSession&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> Cloud = require(</code><code class=\"string\">&apos;ti.cloud&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> session;</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// App UI</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> win = Ti.UI.createWindow({</code></div> <div class=\"line\"><code class=\"plain\"> backgroundColor: </code><code class=\"string\">&apos;white&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> progress = Ti.UI.createProgressBar({</code></div> <div class=\"line\"><code class=\"plain\"> width: 200,</code></div> <div class=\"line\"><code class=\"plain\"> height: 50,</code></div> <div class=\"line\"><code class=\"plain\"> min: 0,</code></div> <div class=\"line\"><code class=\"plain\"> max: 1,</code></div> <div class=\"line\"><code class=\"plain\"> value: 0,</code></div> <div class=\"line\"><code class=\"plain\"> style: Ti.UI.iOS.ProgressBarStyle.PLAIN,</code></div> <div class=\"line\"><code class=\"plain\"> top: 10,</code></div> <div class=\"line\"><code class=\"plain\"> message: </code><code class=\"string\">&apos;Downloading image URL&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> font: { fontSize: 12, fontWeight: </code><code class=\"string\">&apos;bold&apos;</code><code class=\"plain\">},</code></div> <div class=\"line\"><code class=\"plain\"> color: </code><code class=\"string\">&apos;#888&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">win.add(progress);</code></div> <div class=\"line\"><code class=\"keyword\">var</code><code class=\"plain\"> imageView = Ti.UI.createImageView({</code></div> <div class=\"line\"><code class=\"plain\"> top: 100,</code></div> <div class=\"line\"><code class=\"plain\"> height: 350,</code></div> <div class=\"line\"><code class=\"plain\"> width: 250,</code></div> <div class=\"line\"><code class=\"plain\"> image: </code><code class=\"string\">&apos;https://raw.github.com/appcelerator-developer-relations/KitchenSink/master/Resources/images/fence@2x.jpg&apos;</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">win.add(imageView);</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor silent push notifications</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;silentpush&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;silentpush: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Create a background download task</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// The push payload field, download_url, is available to this callback as e.download_url</code></div> <div class=\"line\"><code class=\"plain\"> session.DownloadTask({</code></div> <div class=\"line\"><code class=\"plain\"> url: e.download_url</code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Display a banner message when the download starts</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.scheduleLocalNotification({</code></div> <div class=\"line\"><code class=\"plain\"> alertBody: </code><code class=\"string\">&apos;Background download initiated ...&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> date: </code><code class=\"keyword\">new</code><code class=\"plain\"> Date().getTime() </code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\"> progress.show();</code></div> <div class=\"line\"><code class=\"plain\"> </code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Put the application back to sleep</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.endBackgroundHandler(e.handlerId);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to receive updates on the progress of the download</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadprogress&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the progress indicator</code></div> <div class=\"line\"><code class=\"plain\"> progress.value = (e.totalBytesWritten / e.totalBytesExpectedToWrite);</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when the download completes</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;downloadcompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Download completed: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Update the image</code></div> <div class=\"line\"><code class=\"plain\"> imageView.image = e.data;</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Invalidates the session and cancel any current session tasks</code></div> <div class=\"line\"><code class=\"plain\"> session.invalidateAndCancel();</code></div> <div class=\"line\"><code class=\"plain\">&#xA0;</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Display a banner message when the download finishes</code></div> <div class=\"line\"><code class=\"plain\"> Ti.App.iOS.scheduleLocalNotification({</code></div> <div class=\"line\"><code class=\"plain\"> alertBody: </code><code class=\"string\">&apos;Download completed!&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> date: </code><code class=\"keyword\">new</code><code class=\"plain\"> Date().getTime() </code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\"> progress.hide();</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Monitor this event to know when all session tasks have completed</code></div> <div class=\"line\"><code class=\"plain\">Ti.App.iOS.addEventListener(</code><code class=\"string\">&apos;sessioncompleted&apos;</code><code class=\"plain\">, </code><code class=\"keyword\">function</code><code class=\"plain\">(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;sessioncompleted: &apos;</code><code class=\"plain\"> + JSON.stringify(e));</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\"> (e.success) {</code></div> <div class=\"line\"><code class=\"plain\"> alert(</code><code class=\"string\">&apos;Downloads completed successfully.&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> }</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"comments\">// Register for push notification</code></div> <div class=\"line\"><code class=\"plain\">Ti.Network.registerForPushNotifications({</code></div> <div class=\"line\"><code class=\"plain\"> types: [Ti.Network.NOTIFICATION_TYPE_ALERT],</code></div> <div class=\"line\"><code class=\"plain\"> success: deviceTokenSuccess,</code></div> <div class=\"line\"><code class=\"plain\"> error: deviceTokenError</code></div> <div class=\"line\"><code class=\"plain\">});</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">function</code><code class=\"plain\"> deviceTokenSuccess(e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// Subscribes the device to the &apos;silent_push&apos; channel to listen for silent push alerts</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"comments\">// The channel name is arbitrary and can be anything you wish</code></div> <div class=\"line\"><code class=\"plain\"> Cloud.PushNotifications.subscribeToken({</code></div> <div class=\"line\"><code class=\"plain\"> device_token: e.deviceToken,</code></div> <div class=\"line\"><code class=\"plain\"> channel: </code><code class=\"string\">&apos;silent_push&apos;</code><code class=\"plain\">,</code></div> <div class=\"line\"><code class=\"plain\"> type: </code><code class=\"string\">&apos;ios&apos;</code></div> <div class=\"line\"><code class=\"plain\"> }, </code><code class=\"keyword\">function</code><code class=\"plain\"> (e) {</code></div> <div class=\"line\"><code class=\"plain\"> </code><code class=\"keyword\">if</code><code class=\"plain\"> (e.success) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Subscribed&apos;</code><code class=\"plain\">);</code></div> <div class=\"line\"><code class=\"plain\"> } </code><code class=\"keyword\">else</code><code class=\"plain\"> {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Error:\\n&apos;</code><code class=\"plain\"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div> <div class=\"line\"><code class=\"plain\"> }</code></div> <div class=\"line\"><code class=\"plain\"> });</code></div> <div class=\"line\"><code class=\"plain\">}</code></div> <div class=\"line\">&#xA0;</div> <div class=\"line\"><code class=\"keyword\">function</code><code class=\"plain\"> deviceTokenError(e) {</code></div> <div class=\"line\"><code class=\"plain\"> Ti.API.info(</code><code class=\"string\">&apos;Failed to register for push notifications: &apos;</code><code class=\"plain\"> + e.error);</code></div> <div class=\"line\"><code class=\"plain\">}</code></div> </div> </div> </div> </div> </div><a id=\"editButton\" href=\"https://wiki.appcelerator.org/pages/editpage.action?pageId=37539664\"><span>Edit</span></a> </div> </body> </html> ","title":"iOS Background Services"});