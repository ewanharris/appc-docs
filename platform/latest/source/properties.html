<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">var Alloy = require(&#39;/alloy&#39;),
	_ = require(&#39;/alloy/underscore&#39;)._,
	TAP = Ti.App.Properties;

function S4() {
	return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
}

function guid() {
	return (S4() + S4() + &#39;-&#39; + S4() + &#39;-&#39; + S4() + &#39;-&#39; + S4() + &#39;-&#39; + S4() + S4() + S4());
}

function Sync(method, model, opts) {
	var prefix = model.config.adapter.collection_name ? model.config.adapter.collection_name : &#39;default&#39;;
	var regex = new RegExp(&#39;^(&#39; + prefix + &#39;)\\-(.+)$&#39;);
	var resp = null;

	if (method === &#39;read&#39;) {
		if (model instanceof Backbone.Collection) {
			// is collection
			var list = [];
			_.each(TAP.listProperties(), function(prop) {
				var match = prop.match(regex);
				if (match !== null) {
					list.push(TAP.getObject(prop));
				}
			});
			resp = list;
		} else {
			// is model
			var obj = TAP.getObject(prefix + &#39;-&#39; + model.id);
			model.set(obj);
			resp = model.toJSON();
		}
	} else if (method === &#39;create&#39; || method === &#39;update&#39;) {
		if (!model.id) {
			model.id = guid();
			model.set(model.idAttribute, model.id);
		}
		TAP.setObject(prefix + &#39;-&#39; + model.id, model.toJSON() || {});
		resp = model.toJSON();
	} else if (method === &#39;delete&#39;) {
		TAP.removeProperty(prefix + &#39;-&#39; + model.id);
		model.clear();
		resp = model.toJSON();
	}

	// process success/error handlers, if present
	if (resp) {
		if (_.isFunction(opts.success)) { opts.success(resp); }
		if (method === &#39;read&#39;) { model.trigger(&#39;fetch&#39;); }
	} else {
		if (_.isFunction(opts.error)) { opts.error(resp); }
	}
}

module.exports.sync = Sync;
module.exports.beforeModelCreate = function(config) {
	// make sure we have a populated model object
	config = config || {};
	config.columns = config.columns || {};
	config.defaults = config.defaults || {};

	// give it a default id if it doesn&#39;t exist already
	if (typeof config.columns.id === &#39;undefined&#39; || config.columns.id === null) {
		config.columns.id = &#39;String&#39;;
	}

	return config;
};
</pre>
</body>
</html>
